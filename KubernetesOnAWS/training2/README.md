# 실습 2: GitOps를 사용한 지속적 배포

## 과제 1: CodeCommit 리포지토리 생성

## 과제 2: 실습 배스천 호스트에 연결 및 AWS CodeCommit을 위한 SSH 키를 생성

### 새 ssh 키페어 생성

```bash
mkdir ~/.ssh && cd ~/.ssh # .ssh 폴더 생성
ssh-keygen -t rsa         # 키 페어 생성
chmod 600 ~/.ssh/id_rsa   # 키에 대한 권한 업데이트
```

### 공개키를 업로드하고 gitUser 사용자에 연결

```bash
aws iam upload-ssh-public-key \
--user-name gitUser \
--ssh-public-key-body file://~/.ssh/id_rsa.pub

KEYID=$(aws iam list-ssh-public-keys --user-name gitUser | jq -r '.[] | .[] | .SSHPublicKeyId') && echo $KEYID # 확인
```

### 공개키와 개인키를 연결하는 SSH 구성 파일을 만들기

```bash
cat <<EOF > ~/.ssh/config
Host git-codecommit.*.amazonaws.com
  User ${KEYID}
  IdentityFile ~/.ssh/id_rsa
EOF
chmod 700 ~/.ssh/config
```

### git-codecommit에 SSH 연결하기

```bash
ssh git-codecommit.us-west-2.amazonaws.com
```

## 과제 3: CodePipeline을 사용하여 도커 이미지 생성

### Git 구성정보 업데이트

```bash
git config --global user.email "znxkznxk1030@gmail.com"
git config --global user.name "Arthur Kim"
git config --global init.defaultBranch main
```

### git clone

```bash
cd ~ && git clone ssh://$KEYID@git-codecommit.us-west-2.amazonaws.com/v1/repos/eks-example
```

### 소스 채워 넣기

```bash
cd eks-example
cp -R /lab/task3/website-example/* ./

git add .
git commit -am "Initial commit"
git push

```

## 과제 4: Kubernetes 인프라 정의

### k8s-config clone 하기

```bash
cd ~ && git clone ssh://$KEYID@git-codecommit.us-west-2.amazonaws.com/v1/repos/k8s-config
cd k8s-config
```

### namespaces, workloads 폴더 만들기

```bash
mkdir namespaces workloads
```

### 저장소 세부내용 보기

```bash
aws ecr describe-repositories | jq '.repositories[] | select( .repositoryName == "eks-example")'
```

### repositoryUri를 쉘 변수에 저장

```bash
REPO_URI=$(aws ecr describe-repositories) | jq -r '.repositories[] | select( .repositoryName == "eks-example") | .repositoryUri')
```

### namespaces 메니페스트 파일 정의

```bash
cat << EOF > namespaces/eks-example.yaml
apiVersion: v1
kind: Namespace
metadata:
  labels:
    name: eks-example
  name: eks-example
EOF
```

### Deployment 메니페스트 파일 정의

```bash
cat << EOF > workloads/eks-example-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: eks-example
  namespace: eks-example
  labels:
    app: eks-example
  annotations:
    flux.weave.works/automated: "true"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: eks-example
  template:
    metadata:
      labels:
        app: eks-example
    spec:
      containers:
      - name: eks-example
        image: $REPO_URI
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /
            port: http
        readinessProbe:
          httpGet:
            path: /
            port: http
EOF
```

### Services ( 로드 밸런스 ) 메니페스트 파일 정의

```bash
cat << EOF > workloads/eks-example-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: eks-example
  namespace: eks-example
  labels:
    app: eks-example
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: eks-example
EOF
```

### 변경사항 푸시

```bash
git add .
git commit -am "eks-example-deployment"
git push
```

## 과제 5: Weave Flux 설치

### 클러스터의 모든 네임스페이스, Deployment 및 Service 보기

```bash
kubectl get namespaces,services,deployments,pods --all-namespaces
```

### Flux CLI 설치

```bash
curl -s https://fluxcd.io/install.sh | sudo bash
flux check --pre # 필수 구성요소가 있는지 확인
```

### Flux 클러스터에 배포하고, k8s-config 레포지토리를 이용해서 앱 배포를 부트스트랩하기

```bash
cd ~/k8s-config
flux bootstrap git \
--url=ssh://${KEYID}@git-codecommit.us-west-2.amazonaws.com/v1/repos/k8s-config \
--private-key-file=/home/ssm-user/.ssh/id_rsa \
--branch=main \
--interval=1m0s
```

### 새로 생성된 Flux 매니페스트 확인

```bash
git pull
ls flux-system

cat flux-system/gotk-sync.yaml

kubectl get namespaces

kubectl get deployments,pods --all-namespaces
```

#### gotk-sync.yaml

```yaml
# This manifest was generated by flux. DO NOT EDIT.
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: flux-system
  namespace: flux-system
spec:
  interval: 1m0s
  ref:
    branch: main
  secretRef:
    name: flux-system
  url: ssh://APKAV4BCA62OQZURX4YK@git-codecommit.us-west-2.amazonaws.com/v1/repos/k8s-config
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: flux-system
  namespace: flux-system
spec:
  interval: 10m0s
  path: ./
  prune: true
  sourceRef:
    kind: GitRepository
    name: flux-system
```

### 애플리케이션의 로드밸런서의 IP 찾기

```bash
kubectl describe service eks-example -n eks-example

# LoadBalancer Ingress:     a5ed64f3cfed345a5975038cc6482209-1800975050.us-west-2.elb.amazonaws.com
```

## 과제 6: Kubernetes 클러스터에서 오류 시뮬레이션

```bash
cd ~/k8s-config
git branch -u origin/main main
```

### 빌드시간 10분마다 한번 => 30초당 한번

```bash
sed -i 's/10m0s/30s/g' ~/k8s-config/flux-system/gotk-sync.yaml

git add .
git commit -m "update gotk-sync"
git push

kubectl get events --sort-by=.metadata.creationTimestamp -n flux-system --watch
```

### 새로운 브라우져 탭에서 다음 명령을 실행하여 eks-example Deployment를 삭제하고 네임스페이스에서 Deployment, ReplicaSet, 포드가 재생성되는 과정을 지켜보십시오.

```bash
kubectl delete deployment eks-example -n eks-example && kubectl get events -n eks-example --watch
```
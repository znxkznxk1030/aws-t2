# Planning And Designing Databases on AWS

## 목표

### 학습 목표

- AWS 데이터베이스 솔루션의 측면과 이러한 솔루션을 함께 사용하여 가용성이 높고, 안정적이며, 안전한 최신 애플리케이션을 구축하는 방법에 대해 논의할 수 있습니다.
- AWS 데이터베이스 서비스의 가장 중요한 기능을 직접 체험할 수 있습니다.
- AWS 서비스를 사용하여 다양한 데이터베이스 솔루션을 계획하고 설계할 수 있습니다.

### 과정 목표

- 데이터베이스 개념, 데이터베이스 관리 및 데이터 모델링 기법 적용
- Amazon EC2 인스턴스에서 데이터베이스 호스팅 평가
- 관계형 데이터베이스 서비스와 관련 기능 평가
- 비관계형 데이터베이스 서비스와 관련 기능 평가
- 설계 기준이 각 서비스에 적용되는 방식을 검토
- 각 서비스의 고유한 기능을 기반으로 제반 관리 원칙을 적용

## 주제 A: 클라우드 내 데이터베이스

### 데이터베이스 유형

#### 관계형 데이터베이스

- 참조 무결성, ACID, 트랜잭션, 스키마-온-라이트
- 트랜잭션 워크로드, 전자 상거래, 소셜 미디어 사이트의 대부분, CRM, 재무

#### 비관계형 데이터베이스

- 높은 처리량, 짧은 지연 시간의 읽기 및 쓰기, 무한한 확장
- 비트랜잭션 워크로드, 장바구니, 고객선호

#### 비관계형 문서 ( JSON, ..)

- 문서를 저장하고 모든 특성을 쿼리하여 신속하게 액세스
- 콘텐츠 관리, 개인화, 모바일

#### 비관계형 메모리 ( Cache )

- 마이크로초 단위의 지연시간으로 키를 사용하여 쿼리
- 순위표, 실시간 분석, 캐싱

#### 비관계형 그래프

- 데이터 간의 관계를 빠르고 쉽게 생성하고 탐색
- 부정 행위 탐지, 소셜 네트워킹, 추천 엔진

#### 비관계형 원장

- 애플리케이션 데이터의 모든 변경에 대한 완전하고 변경 불가능하며 확인 가능한 기록
- 레코드 시스템, 공급망, 의료, 등록, 재무시스템F

### 인터넷 규모 아키텍처

- 데이터가 분산
- 연결은 여러 인스턴스에 걸쳐 밸런싱
- 가용성은 확장성을 통해 유지

### 조정

- 수직적 확장: 인스턴스 크기 증가
- 수평적 확장: 시스템 추가 ( 샤딩 )

### CAP 이론: 철의 데이터 삼각형

- 일관성 ( Consistency ): 모든 시스템이 동일한 응답을 생성하도록 보장
- 가용성 ( Availability ): 모든 요청이 응답을 수신하도록 보장
- 파티션 내성 ( Partition tolerance ): 시스템이 파티션 손실 시에도 생존 가능하도록 보장 \* 반드시 있어야함

#### 일관성/ 가용성 => 비분산 관계형 데이터베이스 시스템

- AC 시스템
- 일관적이고 가용성이 높은 데이터를 위해 파티션 내성이 저하되는 시스템

#### 가용성 / 파티션 내성 => 분산 비관계형 데이터베이스 시스템

- AP 시스템
- 가용성이 높은 데이터를 위해 일관성이 저하되는 시스템

#### 일관성 / 파티션 => 분산 관계형 및 비관계형 데이터베이스 시스템

- CP 시스템
- 강력하게 일관적인 데이터를 위해 가용성이 저하되는 시스템

### PIE 이론: 철의 목적 삼각형

#### P: 패턴 유연성 ( Pattern flexibility )

- 시스템이 임의 액세스 패턴 및 일회성 쿼리를 지원하도록 보장

#### I: 무한한 확장 ( Infinite scale )

#### E: 효율성 ( Efficiency )

## 트랜잭션 규정 준수

### ACID 규정준수

### BASE 규정준수

- 기본적 가용성
- 소프트 상태
- 최종 일관성

## 모듈2: 데이터베이스 계획 및 설계

## 워크로드 요구 사항

- 데이터 스토리지
- 데이터 사용
- 데이터 볼륨, 속도 및 다양성
- 데이터 수명
- 내구성 및 가용성

### 데이터 스토리지

- [ ] 파일 시스템
- [ ] 객체 스토어
- [ ] 관계형 데이터베이스
- [ ] 비관계형 데이터베이스

### 데이터 사용

- [ ] 관계형 데이터 구성
  - OLTP vs OLAP
  - DSS
  - 데이터 웨어하우스
- [ ] 비관계형 액세스 패턴
  - IOT
  - 애플리케이션 로그
  - 세션 상태
- [ ] 데이터베이스 사용 및 사용자의 특성
- [ ] 데이터 처리

### 데이터 볼륨, 속도 및 다양성

### 데이터 수명

- 활성
- 임시
- 아카이브

### 내구성 및 가용성

- 내구성: 데이터가 항상 존재함
- 가용성: 필요할 때 데이터 액세스가 가능

## 설계 시 고려 사항

### 성능

- 필수 지연 시간
- IOPS
- 읽기/쓰기 처리량
- 동시성

### 용량 및 규모 조정

#### 용량

- 기록 보기
- 새 요구 사항 조사
- 향후 증가 추정

#### 규모 조정

- 수직/수평
- 수동/자동

### 고가용성

- 읽기 전용 복제본
- 클러스터링
- 다중 AZ 배포
- 다중 리전 배포

### 네트워킹

- 워크로드가 온프레미스에 유지 필요
- VPN 연결
- AWS Direct Connect
- VPC 구성 - public/private subnet 설계

### 백업 및 복구

- 목표 복구 지점 (RPO)
- 목표 복구 시간 (RTO)

### 보안 및 규정 준수

- 보호: 전송 중 암호화, 저장 시 암호화
- 위치별 규제 / 산업별 규제

## WAF ( Well-Archetected Framework )

### 데이터베이스를 EC2로 이동해야 하는 이유

- 대규모 마이그레이션의 첫번째 단계
- 기존 라이선스 유지
- 사용자 지정 로직 및 타사 도구 유지

### EC2 데이터베이스 호스트 비용

- 인스턴스 ( 초당 )
- 데이터베이스 엔진 라이선스
- 스토리지 ( GiB 당 )

### 데이터에서 더 많은 가치를 얻기 위해 고객은

- 리프트 앤 시프트
- 앱을 클라우드에 신속하게 구축

### 개발자 역량

- 복잡한 앱을 작은 마이크로 서비스로 분할하고 각 문제를 해결하는데 최적의 도구 선택
- 잘 설계된 애플리케이션은 느슨하게 결합되고 효율적으로 확장
- 현재 다양한 특수 목적 데이터베이스를 사용하여 고도로 분산된 앱을 빌드

### 데이터 모델

- 데이터 구성, 정의, 메타데이터 및 관계( 있다면 )를 정의하는 추상적 모델

#### 관계형 모델

- 엔터티
- 관계
- 정규화 사용

#### 비관계형 모델

- 키/속성
- 액세스 패턴

#### 비관계형 그래프 모델

- 노드
- 엣지
- 관계사용

## RDS

- Amazon RDS: 완전 관리형

### 성능 개선 도우미

- 데이터 보존 기간 연장
- CloudWatch 로드지표
- CloudFormation 지원
- AWS Management Console 에서 모니터링 간소화

### Amazon RDS 데이터베이스 복원

- 스냅샷에서 복원 ( 항상 새 인스턴스 생성, 스냅샷 이름 및 새 인스턴스 이름 입력, 새 스토리지 유형으로 복원 가능 )
- 지정된 시간으로 복원 ( 5분마다 트랜잭션 로그 업로드 | 데이터베이스 엔진의 특별 고려사항에 유의 )

## Aurora

### 분산 스토리지 볼륨

- 전달기준: Protection Group ( 6개의 카피본 )
- 전 가용영역에 걸쳐 스토리지가 분산되어 있으므로, 새 가용영역에 인스턴스를 올려도 카피를 새로 할 필요가 없다.

### 스토리지 안정성

- 유지 가능한 캐시 워밍: 캐시를 그대로 보존해주는 기능
- 낙관적/비관적 동시성 제어

### 관리 작업 자동화

- Aurora는 시간이 많이 드는 데이터베이스 관리 작업을 처리합니다.
- 이를 통해 애플리케이션과 비즈니스에 더욱 집중할 수 있습니다.

### Aurora vs RDS

- 복제본: 15 / 5
- 복제유형: 비동기식( 밀리초 ) / 비동기식 ( 초 )
- 복제 성능 영향: 스토리지 계층 / 기본 인스턴스
- 장애 조치 대상: 복제본( 데이터 손실 없음 )/ 예비 ( 잠재적으로 몇 분 분량의 손실 )
- 스토리지: 128TB 자동증가/ 최대 64TB, 스토리지 한도 지정
- 자동 장애 조치: 예 ( 복제본 ) / 예 ( 예비 )
- 스토리지 엔진: MySQL InnoDB, PostgresSQL / MySQL (InnoDB, MyISAM), PostgreSQL
- 데이터 캐시 유지: 예 / 아니요

### 병렬 쿼리 클러스터

- 쿼리의 병렬 실행 가능 ( 성능이 크게 향상됨 )
- 클러스터 구성으로 병렬 쿼리 최적화 지원
- 병렬 쿼리가 자동으로 병렬화할 수 있는 쿼리 식별
- 병렬화가 가능한 작업

### 병렬 쿼리 고려사항

- 병렬 쿼리 트리거 (쿼리에는 다음이 포함되어야 함)
  - 수백만 개의 데이터 행
  - 분석 쿼리 ( sum, count, avg )
  - 멀티파트 쿼리 (join, union, merge)
- 병렬 쿼리 방지
  - Limit
  - 전체 텍스트 검색 인덱스가 포함된 테이블
  - 상관 관계가 있는 하위 쿼리

### 클러스터

- 복제본의 이해
  - Primary: 읽기/쓰기 동작을 하는 단일 인스턴스
  - Replica: 읽기 동작만 하는 최대 15개 인스턴스
    - Replica 들은 독립적인 endpoint가 있음
    - Replica 들은 읽기 전용
- 리전간 복제 가능

### MySQL 멀티 마스터 클러스터

- 복제본이 없음
  - 모든 인스턴스가 Primary
  - 모든 인스턴스에서 읽기 및 쓰기 처리
  - 애플리케이션에서 사용할 노드 선택
- 제한된 읽기/쓰기 노드
  - 현재 2개로 제한됨
  - 읽기 전용 노드를 임시로 생성 가능
- 전체-전체 피어 투 피어 복제

### 멀티 마스터 클러스터를 사용해야 하는 이유

- 워크로드 유형
  - 액티브-패시브 - 하나의 활성 노드에서 쓰기/읽기
    - 쓰기 애플리케이션의 가동 중지 최소화
  - 액티브-액티브 - 동시에 모든 노드에 쓰기/읽기
    - 세그먼트화된 워크로드을 생성하는 애플리케이션에 대해 설계됨

### 기계 학습

- 기계 학습 기반 예측을 애플리케이션에 추가할 수 있습니다.

### 장애 조치

- 장애조치는 단일 리전 내에서 항상 자동으로 수행

### 보안

- VPC 격리
- AWS KMS
- AWS IAM
- 저장시 암호화

## DocumentDB

- 컬랙션
- 다큐먼트
- 필드

### 문서

- 데이터는 JSON 유사 형식
- 유연한 스키마 및 인덱싱
- 표현식 쿼리 언어
- 일회성 쿼리 및 집계

### 변경 스트림

- 클러스터의 컬렉션 내에서 발생하는 변경 이벤트의 시간 순서 시퀀스를 제공
- 복구와는 상관 없다.

### PITF ( 특정 시점으로 복구 )

### 빠른 복구를 통한 장애조치

### DocumentDB의 차별점

- 완전 관리형

## Neptune

### 그래프 유형: 리소스

### 그래프 모델 및 프레임워크

- Gremlin : 순회언어, Apache TinkerPop
- SPARQL: 쿼리언어

### Neptune으로 데이터 로드

1. 데이터 파일을 Amazon S3 버킷에 복사
1. IAM 역할 생성
1. S3 VPC 엔드포인트 생성
1. Neptune 로더 시작

## Amazon Quantum Ledger Database ( QLDB )

## Amazon ElastiCache

- 캐싱 솔루션

### 캐시에서 항목 제거

- TTL 기반 제거
- 캐시에서 키가 만료될 때까지의 시간
- 데이터가 가끔씩 새로 고침되오록 보장
- 캐시에 각각의 쓰기에 추가
- 값이 변경 빈도와 일치해야 함
- 캐시가 가득차면 제거
- LRU 또는 임의키
- TTL과 결합하여 휘발성 항목의 우선 순위 지정

### ElastiCache 엔진

- for Memcached
- for Radis

## 질의

### NoSql은 RDS를 대체하기 위해 나왔는가?

- X : 기존의 관계형 데이터베이스가 지원하지 않거나, 지원하나 요구사항을 충족하기 위해 나온 데이터베이스이다.

### [OLTP vs OLAP](https://www.ibm.com/cloud/blog/olap-vs-oltp#:~:text=OLAP%20systems%20are%20designed%20for,a%20massive%20number%20of%20transactions.)

OLAP is optimized for conducting complex data analysis for smarter decision-making. OLAP systems are designed for use by data scientists, business analysts and knowledge workers, and they support business intelligence (BI), data mining and other decision support applications.

OLTP, on the other hand, is optimized for processing a massive number of transactions. OLTP systems are designed for use by frontline workers (e.g., cashiers, bank tellers, hotel desk clerks) or for customer self-service applications

### 참조 무결성이란 ?

- 외래키 값은 NULL이거나 참조 릴레이션의 기본키 값과 동일해야함 즉 릴레이션은 참조할 수 없는 외래키 값을 가질 수 없다

- <수강>릴레이션의 '학번'속성에는 <학생>릴레이션의 '학번' 속성에 없는 값은 입력할 수 없다

### [ACID](https://www.ibm.com/docs/en/cics-ts/5.4?topic=processing-acid-properties-transactions)

- Atomicity, Consistency, Isolation, Durability

### Cluster = Domain

### 액세스 빈도가 높은 데이터는?

- 최근 생성된 데이터

### IOPS?

- Input/Output Operations Per Second
- HDD, SDD 또는 NVMe등 저장장치의 속도를 나타내는데 사용도는 측정 단위

### Default VPC 특징

- 교육목적으로 모든걸 명시적 허용상태로 만들어짐
- 보안적으로 매우 안좋기 때문에 1개의 EC2를 올리더라도 개인 VPC를 만들기 권함

### RDS > Performance Insights

- [성능 개선 도우미](https://aws.amazon.com/ko/rds/performance-insights/?nc=sn&amploc=2&ampdn=3)

### Aurora는 MySql/Postgres와 같은 엔진일까?

- 아니다. 호환이 될 뿐

### [낙관적/비관적 동시성 제어](https://velog.io/@jduck1024/%EB%8F%99%EC%8B%9C%EC%84%B1-%EC%A0%9C%EC%96%B4)

- 비관적 동시성 제어: 데이터를 동시에 수정 한다고 가정 => 데이터를 읽는 시점에 Lock을 건다
- 낙관적 동시성 제어: 데이터를 동시에 수정하지 않는다고 가정 => 데이터를 읽는 시점에 Lock을 걸지 않는다.
- 낙관적 동시성 제어시에는 반드시 수정 시점에 다른 사용자에 의해 변경되었는지 확인해야 한다.
